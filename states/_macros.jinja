{# Reusable Salt state macros for common patterns #}

{# Trigger systemd daemon-reload when listed states change.
   Usage: {{ daemon_reload('unbound', ['cmd: install_unbound', 'file: unbound_override']) }}
#}
{%- macro daemon_reload(name, onchanges) -%}
{{ name }}_daemon_reload:
  cmd.run:
    - name: systemctl daemon-reload
    - onchanges:
{%- for item in onchanges %}
      - {{ item }}
{%- endfor %}
{%- endmacro -%}

{# Download binary directly to ~/.local/bin/ and chmod +x.
   Usage: {{ curl_bin('aliae', 'https://github.com/.../aliae-linux-amd64') }}
          {{ curl_bin('xdg-ninja', 'https://github.com/.../xdgnj') }}
#}
{%- macro curl_bin(name, url) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: curl -fsSL {{ url }} -o ~/.local/bin/{{ name }} && chmod +x ~/.local/bin/{{ name }}
    - runas: neg
    - creates: /var/home/neg/.local/bin/{{ name }}
{%- endmacro -%}

{# Download tar.gz, extract single binary to ~/.local/bin/.
   Usage: {{ github_tar('eza', 'https://github.com/.../eza_x86_64.tar.gz') }}
#}
{%- macro github_tar(name, url) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: |
        set -eo pipefail
        curl -fsSL {{ url }} -o /tmp/{{ name }}.tar.gz
        tar -xzf /tmp/{{ name }}.tar.gz -C /tmp {{ name }}
        install -m755 /tmp/{{ name }} ~/.local/bin/{{ name }}
        rm -f /tmp/{{ name }}.tar.gz /tmp/{{ name }}
    - runas: neg
    - shell: /bin/bash
    - creates: /var/home/neg/.local/bin/{{ name }}
{%- endmacro -%}

{# Download latest GitHub release asset to ~/.local/bin/.
   Fetches TAG via GitHub API, supports direct binary or tar.gz.
   Usage: {{ github_release('sops', 'getsops/sops', 'sops-${TAG}.linux.amd64') }}
          {{ github_release('rmpc', 'mierak/rmpc', 'rmpc-${TAG}-x86_64.tar.gz', format='tar.gz') }}
          {{ github_release('sing-box', 'SagerNet/sing-box', 'sing-box-${VER}.tar.gz', format='tar.gz', strip_v=True) }}
#}
{%- macro github_release(name, repo, asset, bin=None, format='bin', strip_v=False) -%}
{%- set target = bin or name -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: |
        set -eo pipefail
        TAG=$(curl -fsSL https://api.github.com/repos/{{ repo }}/releases/latest | jq -r .tag_name)
{%- if strip_v %}
        VER=${TAG#v}
{%- endif %}
{%- if format == 'bin' %}
        curl -fsSL "https://github.com/{{ repo }}/releases/download/${TAG}/{{ asset }}" -o ~/.local/bin/{{ target }}
        chmod +x ~/.local/bin/{{ target }}
{%- elif format == 'tar.gz' %}
        TMPDIR=$(mktemp -d)
        curl -fsSL "https://github.com/{{ repo }}/releases/download/${TAG}/{{ asset }}" -o "$TMPDIR/archive.tar.gz"
        tar -xzf "$TMPDIR/archive.tar.gz" -C "$TMPDIR"
        find "$TMPDIR" -name '{{ target }}' -type f -exec install -m755 {} ~/.local/bin/{{ target }} \;
        rm -rf "$TMPDIR"
{%- endif %}
    - runas: neg
    - shell: /bin/bash
    - creates: /var/home/neg/.local/bin/{{ target }}
{%- endmacro -%}

{# pip install --user.
   Usage: {{ pip_pkg('httpstat') }}
          {{ pip_pkg('neovim_deps', pkg='pynvim neovim-remote', bin='nvr') }}
#}
{%- macro pip_pkg(name, pkg=None, bin=None) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: pip install --user {{ pkg or name }}
    - runas: neg
    - creates: /var/home/neg/.local/bin/{{ bin or name }}
{%- endmacro -%}

{# cargo install (crates.io or git).
   Usage: {{ cargo_pkg('handlr', pkg='handlr-regex') }}
          {{ cargo_pkg('agg', git='https://github.com/asciinema/agg') }}
          {{ cargo_pkg('pzip', bin='pz') }}
#}
{%- macro cargo_pkg(name, pkg=None, bin=None, git=None) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: cargo install {{ '--git ' ~ git if git else pkg or name }}
    - runas: neg
    - creates: /var/home/neg/.local/share/cargo/bin/{{ bin or name }}
{%- endmacro -%}

{# Install a custom SELinux policy module (compile .te → .pp → semodule -i).
   Uses caller() block for multi-line policy content.
   Usage:
     {% call selinux_policy('ollama_selinux_network', 'ollama-network') %}
     module ollama-network 1.0;
     require { type init_t; type http_port_t; class tcp_socket name_connect; }
     allow init_t http_port_t:tcp_socket name_connect;
     {% endcall %}
#}
{%- macro selinux_policy(state_id, module) -%}
{{ state_id }}:
  cmd.run:
    - name: |
        TMP=$(mktemp -d)
        cat > "$TMP/{{ module }}.te" << 'POLICY'
{{ caller() | trim | indent(8, first=true) }}
        POLICY
        checkmodule -M -m -o "$TMP/{{ module }}.mod" "$TMP/{{ module }}.te"
        semodule_package -o "$TMP/{{ module }}.pp" -m "$TMP/{{ module }}.mod"
        semodule -i "$TMP/{{ module }}.pp"
        rm -rf "$TMP"
    - unless: semodule -l | grep -q '^{{ module }}'
{%- endmacro -%}

{# Set SELinux file context on a path (semanage fcontext + restorecon).
   selinux_path uses equivalency rules (e.g. /mnt not /var/mnt).
   real_path is the actual filesystem path for restorecon.
   check_path overrides what ls -Zd checks (defaults to real_path).
   Usage: {{ selinux_fcontext('steam_selinux', '/mnt/zero/games', '/var/mnt/zero/games', 'user_home_t') }}
          {{ selinux_fcontext('ollama_ctx', '/mnt/one/ollama', '/var/mnt/one/ollama', 'var_lib_t', requires=['file: ollama_models_dir']) }}
#}
{%- macro selinux_fcontext(name, selinux_path, real_path, selinux_type, check_path=None, requires=None) -%}
{{ name }}:
  cmd.run:
    - name: |
        semanage fcontext -a -t {{ selinux_type }} "{{ selinux_path }}(/.*)?" 2>/dev/null || \
        semanage fcontext -m -t {{ selinux_type }} "{{ selinux_path }}(/.*)?"
        restorecon -Rv {{ real_path }}
    - unless: ls -Zd {{ check_path or real_path }} 2>/dev/null | grep -q {{ selinux_type }}
{%- if requires %}
    - require:
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# rpm-ostree install with --apply-live (for conditional/feature-gated packages).
   check defaults to first package. requires is an optional list of requisites.
   Usage: {{ ostree_install('unbound', 'unbound') }}
          {{ ostree_install('jellyfin', 'jellyfin-server jellyfin-web', requires=['file: jellyfin_repo']) }}
#}
{%- macro ostree_install(name, pkgs, check=None, requires=None) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: rpm-ostree install --idempotent --apply-live {{ pkgs }}
    - unless: rpm -q {{ check or pkgs.split()[0] }}
{%- if requires %}
    - require:
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# Create system daemon user + data directory.
   Consolidates: user.present (system user, nologin shell) + file.directory (homedir/datadir with ownership).
   shell defaults to /usr/sbin/nologin. createhome defaults to False (createhome by file.directory instead).
   Usage: {{ system_daemon_user('loki', '/var/lib/loki') }}
          {{ system_daemon_user('adguardhome', '/var/lib/adguardhome') }}
          {{ system_daemon_user('bitcoind', '/var/lib/bitcoind', requires=['cmd: install_bitcoind']) }}
#}
{%- macro system_daemon_user(name, home_dir, shell='/usr/sbin/nologin', requires=None) -%}
{{ name }}_user:
  user.present:
    - name: {{ name }}
    - system: True
    - shell: {{ shell }}
    - home: {{ home_dir }}
    - createhome: False

{{ name }}_data_dir:
  file.directory:
    - name: {{ home_dir }}
    - user: {{ name }}
    - group: {{ name }}
    - makedirs: True
    - require:
      - user: {{ name }}_user
{%- if requires %}
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# Deploy systemd unit file + enable service (file + daemon-reload + service.enabled + optional service.running).
   unit_type: 'service' (default) | 'timer' | 'socket' | etc.
   running: True (default False) to add service.running after enabled for auto-start behavior.
   requires: optional list of state requisites (includes daemon-reload as base requirement).
   Usage: {{ service_with_unit('loki', 'salt://units/loki.service', requires=['cmd: install_loki', 'file: loki_config']) }}
          {{ service_with_unit('fancontrol', 'salt://units/fancontrol.service', running=True, requires=['file: fancontrol_service', 'cmd: install_fancontrol']) }}
#}
{%- macro service_with_unit(name, source, unit_type='service', running=False, requires=None) -%}
{{ name }}_service:
  file.managed:
    - name: /etc/systemd/system/{{ name }}.{{ unit_type }}
    - mode: '0644'
    - source: {{ source }}

{{ name }}_daemon_reload:
  cmd.run:
    - name: systemctl daemon-reload
    - onchanges:
      - file: {{ name }}_service

{{ name }}_enabled:
  service.enabled:
    - name: {{ name }}
    - require:
      - cmd: {{ name }}_daemon_reload
{%- if requires %}
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}

{%- if running %}
{{ name }}_running:
  service.running:
    - name: {{ name }}
    - watch:
      - file: {{ name }}_service
    - require:
      - service: {{ name }}_enabled
{%- endif %}
{%- endmacro -%}
