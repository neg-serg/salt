{# Reusable Salt state macros for common patterns #}

{# Trigger systemd daemon-reload when listed states change.
   Usage: {{ daemon_reload('unbound', ['cmd: install_unbound', 'file: unbound_override']) }}
#}
{%- macro daemon_reload(name, onchanges) -%}
{{ name }}_daemon_reload:
  cmd.run:
    - name: systemctl daemon-reload
    - onchanges:
{%- for item in onchanges %}
      - {{ item }}
{%- endfor %}
{%- endmacro -%}

{# Download binary directly to ~/.local/bin/ and chmod +x.
   Usage: {{ curl_bin('aliae', 'https://github.com/.../aliae-linux-amd64') }}
          {{ curl_bin('xdg-ninja', 'https://github.com/.../xdgnj') }}
#}
{%- macro curl_bin(name, url) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: curl -fsSL {{ url }} -o ~/.local/bin/{{ name }} && chmod +x ~/.local/bin/{{ name }}
    - runas: neg
    - creates: /var/home/neg/.local/bin/{{ name }}
{%- endmacro -%}

{# Download tar.gz, extract single binary to ~/.local/bin/.
   Usage: {{ github_tar('eza', 'https://github.com/.../eza_x86_64.tar.gz') }}
#}
{%- macro github_tar(name, url) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: |
        set -eo pipefail
        curl -fsSL {{ url }} -o /tmp/{{ name }}.tar.gz
        tar -xzf /tmp/{{ name }}.tar.gz -C /tmp {{ name }}
        install -m755 /tmp/{{ name }} ~/.local/bin/{{ name }}
        rm -f /tmp/{{ name }}.tar.gz /tmp/{{ name }}
    - runas: neg
    - shell: /bin/bash
    - creates: /var/home/neg/.local/bin/{{ name }}
{%- endmacro -%}

{# pip install --user.
   Usage: {{ pip_pkg('httpstat') }}
          {{ pip_pkg('neovim_deps', pkg='pynvim neovim-remote', bin='nvr') }}
#}
{%- macro pip_pkg(name, pkg=None, bin=None) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: pip install --user {{ pkg or name }}
    - runas: neg
    - creates: /var/home/neg/.local/bin/{{ bin or name }}
{%- endmacro -%}

{# cargo install (crates.io or git).
   Usage: {{ cargo_pkg('handlr', pkg='handlr-regex') }}
          {{ cargo_pkg('agg', git='https://github.com/asciinema/agg') }}
          {{ cargo_pkg('pzip', bin='pz') }}
#}
{%- macro cargo_pkg(name, pkg=None, bin=None, git=None) -%}
install_{{ name | replace('-', '_') }}:
  cmd.run:
    - name: cargo install {{ '--git ' ~ git if git else pkg or name }}
    - runas: neg
    - creates: /var/home/neg/.local/share/cargo/bin/{{ bin or name }}
{%- endmacro -%}

{# Install a custom SELinux policy module (compile .te → .pp → semodule -i).
   Uses caller() block for multi-line policy content.
   Usage:
     {% call selinux_policy('ollama_selinux_network', 'ollama-network') %}
     module ollama-network 1.0;
     require { type init_t; type http_port_t; class tcp_socket name_connect; }
     allow init_t http_port_t:tcp_socket name_connect;
     {% endcall %}
#}
{%- macro selinux_policy(state_id, module) -%}
{{ state_id }}:
  cmd.run:
    - name: |
        TMP=$(mktemp -d)
        cat > "$TMP/{{ module }}.te" << 'POLICY'
{{ caller() | trim | indent(8, first=true) }}
        POLICY
        checkmodule -M -m -o "$TMP/{{ module }}.mod" "$TMP/{{ module }}.te"
        semodule_package -o "$TMP/{{ module }}.pp" -m "$TMP/{{ module }}.mod"
        semodule -i "$TMP/{{ module }}.pp"
        rm -rf "$TMP"
    - unless: semodule -l | grep -q '^{{ module }}'
{%- endmacro -%}
