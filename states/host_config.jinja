{#
    Per-host configuration map.

    Usage in any .sls file:
      {% from 'host_config.jinja' import host %}
      {% if host.is_laptop %}
        ...laptop-specific states...
      {% endif %}

    To add a new host, create a new entry in the `hosts` dict.
    Any key not specified inherits from `defaults`.
#}

{% set defaults = {
    'user':           'neg',
    'home':           '/home/neg',
    'uid':            1000,
    'is_laptop':      False,
    'cpu_vendor':     'amd',
    'kvm_module':     'kvm_amd',
    'display':        '',
    'hostname':       grains['host'],
    'extra_kargs':    [],
    'extra_modules':  [],
    'features': {
        'monitoring': {
            'sysstat':  True,
            'vnstat':   True,
            'netdata':  True,
            'loki':     False,
            'promtail': False,
            'grafana':  False,
        },
        'fancontrol':   False,
        'kernel': {
            'variant':  'lto',
        },
        'dns': {
            'unbound':      False,
            'adguardhome':  False,
            'avahi':        True,
        },
        'services': {
            'samba':        False,
            'jellyfin':     False,
            'bitcoind':     False,
            'duckdns':      False,
            'transmission': False,
        },
        'network': {
            'vm_bridge': False,
            'xray':      False,
            'singbox':   False,
            'wifi':      False,
        },
        'amnezia':      True,
        'steam':        True,
        'mpd':          True,
        'ollama':       True,
        'floorp':       True,
        'hy3':          True,
        'kanata':       True,
    },
} %}

{% set hosts = {
    'telfir': {
        'display':        '3840x2160@240',
        'hostname':       'telfir',
        'extra_modules':  ['ec_sys', 'asus_ec_sensors'],
        'features': {
            'fancontrol':   True,
            'services': {
                'transmission': True,
            },
        },
    },
} %}

{# Hostname aliases for migration (e.g. first run before rename) #}
{% set aliases = {
    'cachyos': 'telfir',
} %}

{# Build merged host config: host-specific values override defaults (recursive deep merge) #}
{% set current_host = aliases.get(grains['host'], grains['host']) %}
{% set host = salt['slsutil.merge'](defaults, hosts.get(current_host, {}), strategy='recurse') %}
{# Derived fields (depend on merged values, so computed after merge) #}
{% do host.update({'runtime_dir': '/run/user/' ~ host.uid|string}) %}
