{#
    Per-host configuration map.

    Usage in any .sls file:
      {% from 'host_config.jinja' import host %}
      {% if host.is_laptop %}
        ...laptop-specific states...
      {% endif %}

    To add a new host, create a new entry in the `hosts` dict.
    Any key not specified inherits from `defaults`.
#}

{% set defaults = {
    'is_laptop':      False,
    'cpu_vendor':     'amd',
    'kvm_module':     'kvm-amd',
    'display':        '',
    'hostname':       grains['host'],
    'extra_kargs':    [],
    'extra_modules':  [],
    'features': {
        'monitoring': {
            'sysstat':  True,
            'vnstat':   True,
            'netdata':  True,
            'loki':     False,
            'promtail': False,
            'grafana':  False,
        },
        'fancontrol':   False,
        'dns': {
            'unbound':      False,
            'adguardhome':  False,
            'avahi':        True,
        },
        'services': {
            'samba':     False,
            'jellyfin':  False,
            'bitcoind':  False,
            'duckdns':   False,
        },
        'network': {
            'vm_bridge': False,
            'xray':      False,
            'singbox':   False,
        },
    },
} %}

{% set hosts = {
    'telfir': {
        'is_laptop':      False,
        'cpu_vendor':     'amd',
        'kvm_module':     'kvm-amd',
        'display':        '3840x2160@240',
        'hostname':       'telfir',
        'extra_modules':  ['ec_sys', 'asus_ec_sensors'],
        'features': {
            'monitoring': {
                'sysstat':  True,
                'vnstat':   True,
                'netdata':  True,
                'loki':     False,
                'promtail': False,
                'grafana':  False,
            },
            'fancontrol':   True,
            'dns': {
                'unbound':      True,
                'adguardhome':  True,
                'avahi':        True,
            },
        },
    },
} %}

{# Hostname aliases for migration (e.g. first run before rename) #}
{% set aliases = {
    'fedora': 'telfir',
} %}

{# Merge: overlay host-specific values on top of defaults.
   For nested dicts (features), merge sub-keys individually. #}
{% set current_host = aliases.get(grains['host'], grains['host']) %}
{% set _host = {} %}
{% set _src = hosts.get(current_host, {}) %}

{% for key, val in defaults.items() %}
    {% if key in _src %}
        {% if val is mapping and _src[key] is mapping %}
            {# Two-level merge for nested dicts like features #}
            {% set _merged = {} %}
            {% for sk, sv in val.items() %}
                {% if sk in _src[key] %}
                    {% if sv is mapping and _src[key][sk] is mapping %}
                        {# Third level: merge monitoring sub-dict etc. #}
                        {% set _sub = {} %}
                        {% for ssk, ssv in sv.items() %}
                            {% do _sub.update({ssk: _src[key][sk].get(ssk, ssv)}) %}
                        {% endfor %}
                        {% for ssk, ssv in _src[key][sk].items() %}
                            {% if ssk not in sv %}
                                {% do _sub.update({ssk: ssv}) %}
                            {% endif %}
                        {% endfor %}
                        {% do _merged.update({sk: _sub}) %}
                    {% else %}
                        {% do _merged.update({sk: _src[key][sk]}) %}
                    {% endif %}
                {% else %}
                    {% do _merged.update({sk: sv}) %}
                {% endif %}
            {% endfor %}
            {% for sk, sv in _src[key].items() %}
                {% if sk not in val %}
                    {% do _merged.update({sk: sv}) %}
                {% endif %}
            {% endfor %}
            {% do _host.update({key: _merged}) %}
        {% else %}
            {% do _host.update({key: _src[key]}) %}
        {% endif %}
    {% else %}
        {% do _host.update({key: val}) %}
    {% endif %}
{% endfor %}

{% set host = _host %}
