{#
    Per-host configuration map.

    Usage in any .sls file:
      {% from 'host_config.jinja' import host %}
      {% if host.is_laptop %}
        ...laptop-specific states...
      {% endif %}

    To add a new host, create a new entry in the `hosts` dict.
    Any key not specified inherits from `defaults`.
#}

{# Recursive deep merge: overlay values override base, nested dicts merge recursively #}
{%- macro _deep_merge(target, base, overlay) -%}
    {%- for key in base -%}
        {%- if key in overlay -%}
            {%- if base[key] is mapping and overlay[key] is mapping -%}
                {%- set _sub = {} -%}
                {%- do target.update({key: _sub}) -%}
                {{- _deep_merge(_sub, base[key], overlay[key]) -}}
            {%- else -%}
                {%- do target.update({key: overlay[key]}) -%}
            {%- endif -%}
        {%- else -%}
            {%- do target.update({key: base[key]}) -%}
        {%- endif -%}
    {%- endfor -%}
    {%- for key in overlay if key not in base -%}
        {%- do target.update({key: overlay[key]}) -%}
    {%- endfor -%}
{%- endmacro -%}

{% set defaults = {
    'is_laptop':      False,
    'cpu_vendor':     'amd',
    'kvm_module':     'kvm-amd',
    'display':        '',
    'hostname':       grains['host'],
    'extra_kargs':    [],
    'extra_modules':  [],
    'features': {
        'monitoring': {
            'sysstat':  True,
            'vnstat':   True,
            'netdata':  True,
            'loki':     False,
            'promtail': False,
            'grafana':  False,
        },
        'fancontrol':   False,
        'kernel': {
            'variant':  'lto',
        },
        'dns': {
            'unbound':      False,
            'adguardhome':  False,
            'avahi':        True,
        },
        'services': {
            'samba':     False,
            'jellyfin':  False,
            'bitcoind':  False,
            'duckdns':   False,
        },
        'network': {
            'vm_bridge': False,
            'xray':      False,
            'singbox':   False,
        },
    },
} %}

{% set hosts = {
    'telfir': {
        'is_laptop':      False,
        'cpu_vendor':     'amd',
        'kvm_module':     'kvm-amd',
        'display':        '3840x2160@240',
        'hostname':       'telfir',
        'extra_modules':  ['ec_sys', 'asus_ec_sensors'],
        'features': {
            'monitoring': {
                'sysstat':  True,
                'vnstat':   True,
                'netdata':  True,
                'loki':     False,
                'promtail': False,
                'grafana':  False,
            },
            'fancontrol':   True,
            'dns': {
                'unbound':      False,
                'adguardhome':  False,
                'avahi':        True,
            },
        },
    },
} %}

{# Hostname aliases for migration (e.g. first run before rename) #}
{% set aliases = {
    'cachyos': 'telfir',
} %}

{# Build merged host config: host-specific values override defaults #}
{% set current_host = aliases.get(grains['host'], grains['host']) %}
{% set _host = {} %}
{{- _deep_merge(_host, defaults, hosts.get(current_host, {})) -}}
{% set host = _host %}
