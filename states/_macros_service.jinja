{# Service-related macros: ensure_running, service_stopped, service_with_healthcheck, unit_override, service_with_unit, user_service_file, system_daemon_user #}

{% from 'host_config.jinja' import host %}
{% set _user = host.user %}
{% set _home = host.home %}

{# Clear failed state + ensure service is running with config watches.
   Emits two states: {{ name }}_reset_failed and {{ name }}_running.
   Usage: {{ ensure_running('unbound', watch=['file: unbound_config']) }}
          {{ ensure_running('adguardhome', watch=['file: adguardhome_service']) }}
#}
{%- macro ensure_running(name, watch=None) -%}
{{ name }}_reset_failed:
  cmd.run:
    - name: systemctl reset-failed {{ name }} 2>/dev/null; true
    - onlyif: systemctl is-failed {{ name }}
    - require:
      - service: {{ name }}_enabled

{{ name }}_running:
  service.running:
    - name: {{ name }}
{%- if watch %}
    - watch:
{%- for w in watch %}
      - {{ w }}
{%- endfor %}
{%- endif %}
    - require:
      - service: {{ name }}_enabled
      - cmd: {{ name }}_reset_failed
{%- endmacro -%}

{# Stop and disable a service (service.dead + enable: False), or just disable (service.disabled).
   stop: True (default) = stop + disable; False = disable only (leave running until reboot).
   Usage: {{ service_stopped('disable_tuned', 'tuned') }}
          {{ service_stopped('disable_sddm', 'sddm') }}
          {{ service_stopped('samba_not_enabled', 'smb', stop=False, requires=['file: samba_config']) }}
#}
{%- macro service_stopped(name, svc, stop=True, requires=None) -%}
{{ name }}:
{%- if stop %}
  service.dead:
    - name: {{ svc }}
    - enable: False
{%- else %}
  service.disabled:
    - name: {{ svc }}
{%- endif %}
{%- if requires %}
    - require:
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# Restart service and poll a health-check command until it succeeds.
   Skips entirely if the check already passes (unless guard).
   check_cmd: shell command that returns 0 when service is ready (e.g. curl probe).
   timeout: seconds to poll before failing (default 30).
   Usage: {{ service_with_healthcheck('ollama_start', 'ollama', 'curl -sf http://127.0.0.1:11434/api/tags >/dev/null 2>&1', requires=['service: ollama_enabled']) }}
#}
{%- macro service_with_healthcheck(name, service, check_cmd, timeout=30, requires=None) -%}
{{ name }}:
  cmd.run:
    - name: |
        systemctl daemon-reload
        systemctl restart {{ service }}
        for i in $(seq 1 {{ timeout }}); do
          {{ check_cmd }} && exit 0
          sleep 1
        done
        echo "{{ service }} failed to start within {{ timeout }}s" >&2
        exit 1
    - shell: /bin/bash
    - unless: {{ check_cmd }}
{%- if requires %}
    - require:
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# Create system daemon user + data directory.
   Consolidates: user.present (system user, nologin shell) + file.directory (homedir/datadir with ownership).
   shell defaults to /usr/sbin/nologin. createhome defaults to False (createhome by file.directory instead).
   Usage: {{ system_daemon_user('loki', '/var/lib/loki') }}
          {{ system_daemon_user('adguardhome', '/var/lib/adguardhome') }}
          {{ system_daemon_user('bitcoind', '/var/lib/bitcoind', requires=['cmd: install_bitcoind']) }}
#}
{%- macro system_daemon_user(name, home_dir, shell='/usr/sbin/nologin', requires=None) -%}
{{ name }}_user:
  user.present:
    - name: {{ name }}
    - system: True
    - shell: {{ shell }}
    - home: {{ home_dir }}
    - createhome: False

{{ name }}_data_dir:
  file.directory:
    - name: {{ home_dir }}
    - user: {{ name }}
    - group: {{ name }}
    - makedirs: True
    - require:
      - user: {{ name }}_user
{%- if requires %}
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endmacro -%}

{# Deploy systemd unit drop-in override + trigger daemon-reload on change.
   Creates parent .d/ directory automatically via makedirs.
   Emits two states: {{ name }} (file.managed) and {{ name }}_reload (daemon-reload).
   Usage: {{ unit_override('netdata_override', 'netdata.service', 'salt://units/netdata-override.conf') }}
          {{ unit_override('unbound_restart_override', 'unbound.service', 'salt://units/unbound-restart-override.conf', filename='restart.conf', requires=['cmd: install_unbound']) }}
#}
{%- macro unit_override(name, service, source, filename='override.conf', requires=None) -%}
{{ name }}:
  file.managed:
    - name: /etc/systemd/system/{{ service }}.d/{{ filename }}
    - source: {{ source }}
    - makedirs: True
    - mode: '0644'
{%- if requires %}
    - require:
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}

{{ name }}_reload:
  cmd.run:
    - name: systemctl daemon-reload
    - onchanges:
      - file: {{ name }}
{%- endmacro -%}

{# Deploy systemd user unit file (~/.config/systemd/user/) from units/user/.
   Usage: {{ user_service_file('mbsync_gmail_service', 'mbsync-gmail.service') }}
          {{ user_service_file('vicinae_service', 'vicinae.service') }}
#}
{%- macro user_service_file(name, filename, user=_user, home=_home) -%}
{{ name }}:
  file.managed:
    - name: {{ home }}/.config/systemd/user/{{ filename }}
    - source: salt://units/user/{{ filename }}
    - user: {{ user }}
    - group: {{ user }}
    - mode: '0644'
    - makedirs: True
{%- endmacro -%}

{# Deploy systemd unit file + manage service (file + daemon-reload + enable/disable + optional running).
   unit_type: 'service' (default) | 'timer' | 'socket' | etc.
   running: True (default False) to add reset_failed + service.running with watch for auto-restart.
   enabled: True (default) = service.enabled; False = service.disabled; None = skip enable/disable.
   requires: optional list of state requisites (includes daemon-reload as base requirement).
   template: 'jinja' (default None) to render the unit file as a Jinja template.
   context: dict of template variables (default None), used with template='jinja'.
   onlyif: guard for service.enabled (default None), e.g. 'command -v ollama'.
   companion: optional second unit source for service+timer pairs (daemon-reload watches both).
   Usage: {{ service_with_unit('loki', 'salt://units/loki.service', requires=['cmd: install_loki', 'file: loki_config']) }}
          {{ service_with_unit('ollama', 'salt://units/ollama.service', template='jinja', context={'user': user, 'home': home}, onlyif='command -v ollama') }}
          {{ service_with_unit('xray', 'salt://units/xray.service', enabled=False) }}
          {{ service_with_unit('duckdns-update', 'salt://units/duckdns-update.timer', unit_type='timer', enabled=False, companion='salt://units/duckdns-update.service') }}
#}
{%- macro service_with_unit(name, source, unit_type='service', running=False, enabled=True, requires=None, template=None, context=None, onlyif=None, companion=None) -%}
{{ name }}_service:
  file.managed:
    - name: /etc/systemd/system/{{ name }}.{{ unit_type }}
    - mode: '0644'
    - source: {{ source }}
{%- if template %}
    - template: {{ template }}
{%- endif %}
{%- if context %}
    - context:
{%- for key, val in context.items() %}
        {{ key }}: {{ val }}
{%- endfor %}
{%- endif %}
{%- if companion %}

{{ name }}_companion:
  file.managed:
    - name: /etc/systemd/system/{{ name }}.{{ 'service' if unit_type != 'service' else 'timer' }}
    - mode: '0644'
    - source: {{ companion }}
{%- if template %}
    - template: {{ template }}
{%- endif %}
{%- if context %}
    - context:
{%- for key, val in context.items() %}
        {{ key }}: {{ val }}
{%- endfor %}
{%- endif %}
{%- endif %}

{{ name }}_daemon_reload:
  cmd.run:
    - name: systemctl daemon-reload
    - onchanges:
      - file: {{ name }}_service
{%- if companion %}
      - file: {{ name }}_companion
{%- endif %}
{%- if enabled is not none %}

{{ name }}_{{ 'enabled' if enabled else 'disabled' }}:
  service.{{ 'enabled' if enabled else 'disabled' }}:
    - name: {{ name }}
{%- if onlyif and enabled %}
    - onlyif: {{ onlyif }}
{%- endif %}
    - require:
      - cmd: {{ name }}_daemon_reload
{%- if requires %}
{%- for req in requires %}
      - {{ req }}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- if running %}

{{ name }}_reset_failed:
  cmd.run:
    - name: systemctl reset-failed {{ name }} 2>/dev/null; true
    - onlyif: systemctl is-failed {{ name }}
    - require:
      - service: {{ name }}_enabled

{{ name }}_running:
  service.running:
    - name: {{ name }}
    - watch:
      - file: {{ name }}_service
    - require:
      - service: {{ name }}_enabled
      - cmd: {{ name }}_reset_failed
{%- endif %}
{%- endmacro -%}
