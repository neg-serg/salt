#!/bin/sh
# unlock: unlock SSH keys (optionally Yubikey) via expect using gopass secrets
# Usage: unlock

cleanup() { unset pp0 pp1 pp2 || true; }
trap cleanup EXIT HUP INT TERM

# Ensure gpg-agent is ready (provides SSH agent via enable-ssh-support)
gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

# Retrieve secrets
pp0="$(gopass show -o ssh-key)"
# Quietly try to get the work key, ignore if missing
if gopass show -o wrk/ssh-key >/dev/null 2>&1; then
    pp2="$(gopass show -o wrk/ssh-key)"
fi

# YubiKey handling
if lsusb | grep -q "0407 Yubico"; then
    pp1="$(gopass show -o yubikey-pin)"
    expect << EOF
        spawn "$XDG_CONFIG_HOME/zsh/ylock"
        expect "Enter passphrase"
        send "$pp1\r"
        expect eof
EOF
fi

# Main key handling
expect << EOF
    spawn ssh-add $HOME/.ssh/id_ed25519
    expect "Enter passphrase"
    send "$pp0\r"
    expect eof
EOF
