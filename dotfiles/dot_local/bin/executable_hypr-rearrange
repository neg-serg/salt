#!/usr/bin/env python3
"""Rearrange Hyprland windows to their configured workspaces."""

import glob
import json
import os
import re
import subprocess
import sys


def get_hyprctl_json(cmd_type):
    try:
        result = subprocess.run(
            ["hyprctl", "-j", cmd_type],
            capture_output=True,
            text=True,
            check=True,
        )
        return json.loads(result.stdout)
    except subprocess.CalledProcessError as e:
        print(f"Error running hyprctl -j {cmd_type}: {e}", file=sys.stderr)
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(
            f"Error parsing JSON from hyprctl -j {cmd_type}: {e}",
            file=sys.stderr,
        )
        sys.exit(1)


def parse_config_file(path, visited=None):
    if visited is None:
        visited = set()

    path = os.path.expandvars(os.path.expanduser(path))
    if not os.path.isabs(path):
        path = os.path.join(os.path.expanduser("~/.config/hypr/"), path)

    paths = glob.glob(path)
    rules = []

    for p in paths:
        real_p = os.path.realpath(p)
        if real_p in visited:
            continue
        visited.add(real_p)

        try:
            with open(real_p, "r", encoding="utf-8") as f:
                lines = f.readlines()
        except Exception as e:
            print(
                f"Warning: could not read config file {p}: {e}",
                file=sys.stderr,
            )
            continue

        for line in lines:
            line = line.strip()
            if not line or line.startswith("#"):
                continue

            if line.startswith("source ="):
                try:
                    src_path = line.split("=", 1)[1].strip()
                    rules.extend(parse_config_file(src_path, visited))
                except Exception:
                    pass
                continue

            if not (line.startswith("windowrule") and "=" in line):
                continue

            parts = line.split("=", 1)
            rule_def = parts[1].strip()

            if "," not in rule_def:
                continue

            args = [a.strip() for a in rule_def.split(",")]
            if len(args) < 2:
                continue

            action = args[0]

            if not action.startswith("workspace"):
                continue

            ws_part = action.split()
            if len(ws_part) < 2:
                continue

            workspace_id = ws_part[1]
            if not workspace_id:
                continue

            first_comma_idx = rule_def.find(",")
            if first_comma_idx == -1:
                continue

            condition_part = rule_def[first_comma_idx + 1 :].strip()

            rule_type = "class"
            pattern = condition_part

            if line.startswith("windowrulev2"):
                if condition_part.startswith("class:"):
                    rule_type = "class"
                    pattern = condition_part[6:]
                elif condition_part.startswith("title:"):
                    rule_type = "title"
                    pattern = condition_part[6:]
                elif condition_part.startswith("initialClass:"):
                    rule_type = "initialClass"
                    pattern = condition_part[13:]
                elif condition_part.startswith("initialTitle:"):
                    rule_type = "initialTitle"
                    pattern = condition_part[13:]
                else:
                    continue

            if workspace_id and pattern:
                rules.append(
                    {
                        "ws": workspace_id,
                        "type": rule_type,
                        "pattern": pattern,
                    }
                )

    return rules


def get_config_rules():
    main_conf = "~/.config/hypr/hyprland.conf"
    return parse_config_file(main_conf)


def match_rule(client, rules):
    client_class = client.get("class", "")
    client_title = client.get("title", "")
    client_initial_class = client.get("initialClass", "")
    client_initial_title = client.get("initialTitle", "")

    for rule in rules:
        pattern = rule["pattern"]
        r_type = rule["type"]

        matched = False
        try:
            if r_type == "class":
                if re.search(pattern, client_class):
                    matched = True
            elif r_type == "title":
                if re.search(pattern, client_title):
                    matched = True
            elif r_type == "initialClass":
                if re.search(pattern, client_initial_class):
                    matched = True
            elif r_type == "initialTitle":
                if re.search(pattern, client_initial_title):
                    matched = True
        except re.error:
            continue

        if matched:
            return rule["ws"]

    return None


def main():
    dry_run = "--dry-run" in sys.argv

    clients = get_hyprctl_json("clients")
    rules = get_config_rules()

    print(f"Found {len(clients)} clients and {len(rules)} workspace rules.")

    moves = []

    for client in clients:
        address = client["address"]
        current_ws_id = str(client["workspace"]["id"])
        current_ws_name = client["workspace"]["name"]

        if client["workspace"]["id"] < 0:
            continue

        target_ws = match_rule(client, rules)

        if target_ws:
            target_simple = target_ws
            if (
                target_simple != current_ws_id
                and target_simple != current_ws_name
            ):
                if (
                    target_simple.startswith("name:")
                    and target_simple[5:] == current_ws_name
                ):
                    continue

                print(
                    f"Match: {client['class']} ({client['title'][:20]}...) -> "
                    f"Rule target: {target_ws} (Current: {current_ws_name})"
                )
                moves.append((address, target_ws))

    if not moves:
        print("No windows need moving.")
        return

    print(f"\nMoving {len(moves)} windows...")

    batch_cmds = []
    for addr, ws in moves:
        cmd = f"dispatch movetoworkspacesilent {ws},address:{addr}"
        batch_cmds.append(cmd)

        if dry_run:
            print(f"[DRY RUN] {cmd}")

    if not dry_run:
        full_batch = " ; ".join(batch_cmds)
        try:
            subprocess.run(["hyprctl", "--batch", full_batch], check=True)
            print("Done.")
        except subprocess.CalledProcessError as e:
            print(f"Error executing moves: {e}")


if __name__ == "__main__":
    main()
