#!/usr/bin/env bash
set -euo pipefail

runtime="$XDG_RUNTIME_DIR"
if [ -z "$runtime" ]; then
  runtime="/run/user/$(id -u)"
fi
sig="$HYPRLAND_INSTANCE_SIGNATURE"

# Validate existing signature; otherwise select newest hypr instance
if [ -n "$sig" ] && [ -S "$runtime/hypr/$sig/.socket.sock" ]; then
  :
else
  if [ -d "$runtime/hypr" ]; then
    newest="$(ls -td "$runtime/hypr"/* 2>/dev/null | head -n1 || true)"
    if [ -n "$newest" ]; then
      cand="$(basename -- "$newest" || true)"
      if [ -S "$runtime/hypr/$cand/.socket.sock" ] || [ -S "$runtime/hypr/$cand/.socket2.sock" ]; then
        sig="$cand"
      else
        sig=""
      fi
    fi
  else
    sig=""
  fi
fi

if [ -z "$sig" ]; then
  echo "pypr-run: Hyprland not detected (no signature)." >&2
  exit 1
fi

export HYPRLAND_INSTANCE_SIGNATURE="$sig"
exec pypr "$@"
