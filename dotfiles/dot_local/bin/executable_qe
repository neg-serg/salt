#!/usr/bin/env bash
set -euo pipefail

# qe: print the most recently modified subdirectory of the given directory.
# Semantics are similar to the original zsh glob:
#   ^.git*(/om[1]D)
# i.e.:
#   - look only at direct children (depth 1)
#   - pick directories (including dot-dirs), excluding .git*
#   - choose the one with the newest mtime
#
# Usage:
#   qe            # last modified subdir of $PWD
#   qe /path/dir  # last modified subdir of the given directory

start="${1:-.}"

# Move to the starting directory; on failure just print it and exit.
if ! cd "$start" 2>/dev/null; then
  printf '%s\n' "$start"
  exit 0
fi

# Find immediate subdirectories (excluding .git*), sorted by mtime (newest first).
# Requires GNU find (available on NixOS via coreutils/findutils).
latest="$(
  find . -mindepth 1 -maxdepth 1 -type d ! -name '.git*' -printf '%T@ %P\n' 2>/dev/null \
    | sort -nr \
    | head -n1 \
    | cut -d' ' -f2-
)"

if [ -n "${latest:-}" ]; then
  # Print an absolute path for robustness.
  cd "$latest" 2>/dev/null || {
    # If cd fails for some reason, fall back to echoing the relative name.
    printf '%s\n' "$latest"
    exit 0
  }
  pwd
else
  # No subdirectories found; fall back to the starting directory.
  pwd
fi
