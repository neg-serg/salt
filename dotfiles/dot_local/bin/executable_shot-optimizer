#!/bin/sh
# shot-optimizer: convert new BMP screenshots to PNG and remove BMP
# Usage: shot-optimizer
#   Watches ~/pic/shots for new .bmp files, converts to .png and deletes .bmp

IFS=' 	
'
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  sed -n '2,4p' "$0" | sed 's/^# \{0,1\}//'; exit 0
fi

need() { command -v "$1" >/dev/null 2>&1 || { printf 'shot-optimizer: missing %s\n' "$1" >&2; :; }; }
need inotifywait
need convert

shots_dir="${HOME}/pic/shots"
mkdir -p -- "$shots_dir"

# Monitor only BMP creations/close_write, handle per-file to avoid rescans
inotifywait -q -m -e close_write -e create --format '%w%f' "$shots_dir" \
  | while IFS= read -r path; do
        case "$path" in
            *.bmp|*.BMP)
                png="${path%.*}.png"
                if convert -quality 10 -- "$path" "$png"; then
                    rm -f -- "$path"
                fi
                ;;
            *) :;;
        esac
    done
