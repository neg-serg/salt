#!/bin/bash
# Wrapper script for xdg-desktop-portal-termfilechooser
# Launches yazi in kitty as a file chooser / save dialog

OUTPUT_PATH=""
METHOD="open"
SUGGESTED_FILENAME=""
CWD_FILE="/tmp/yazi_cwd_$$"

for arg in "$@"; do
  case "$arg" in
    --chooser-file) ;;
    *)
      if [ -z "$OUTPUT_PATH" ] && [[ "$arg" == /* ]]; then
         OUTPUT_PATH="$arg"
      elif [ -n "$OUTPUT_PATH" ] && [[ "$arg" != -* ]] && [[ "$arg" != /* ]]; then
         SUGGESTED_FILENAME="$arg"
         METHOD="save"
      fi
      ;;
  esac
done

if [ -z "$OUTPUT_PATH" ]; then
   OUTPUT_PATH="/tmp/yazi_chooser_out"
fi

if [ -n "$SUGGESTED_FILENAME" ]; then
   METHOD="save"
fi

kitty --detach=no sh -c "
  export YAZI_FILE_CHOOSER_PATH='$OUTPUT_PATH'
  export YAZI_SUGGESTED_FILENAME='$SUGGESTED_FILENAME'

  if [ \"$METHOD\" = \"save\" ]; then
     yazi --cwd-file='$CWD_FILE'
     if [ -s '$OUTPUT_PATH' ]; then
        exit 0
     fi
  else
     yazi --chooser-file='$OUTPUT_PATH'
  fi
  rm -f '$CWD_FILE'
"
