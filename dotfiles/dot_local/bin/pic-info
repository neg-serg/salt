#!/bin/sh
# pic-info: show screenshot metadata via pic-notify (auto-picks latest shot when no args).

set -u

usage() {
  cat <<'USAGE'
Usage: pic-info [FILE...]
  Without arguments, inspects the newest file inside $PIC_INFO_DIR (or $GRIM_DEFAULT_DIR).
  For each file, forwards the preview request to pic-notify.
USAGE
}

expand_path() {
  case "${1:-}" in
    "~") printf '%s\n' "$HOME" ;;
    "~/"*) printf '%s/%s\n' "$HOME" "${1#~/}" ;;
    *) printf '%s\n' "$1" ;;
  esac
}

default_shots_dir() {
  base="${PIC_INFO_DIR:-${GRIM_DEFAULT_DIR:-}}"
  if [ -z "$base" ]; then
    pictures="${XDG_PICTURES_DIR:-$HOME/pic}"
    base="${pictures%/}/shots"
  fi
  expand_path "$base"
}

pick_latest() {
  dir="$1"
  [ -d "$dir" ] || return 1
  latest=$(
    find "$dir" -maxdepth 1 -type f -printf '%T@ %p\0' 2>/dev/null \
      | sort -zr -n \
      | {
          IFS= read -r -d '' entry || exit 1
          printf '%s' "${entry#* }"
        } || true
  )
  [ -n "${latest:-}" ] || return 1
  printf '%s\n' "$latest"
}

notify_bin="$(command -v pic-notify || true)"
if [ -z "$notify_bin" ]; then
  printf 'pic-info: pic-notify not found in PATH\n' >&2
  exit 1
fi

case "${1:-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

if [ "$#" -eq 0 ]; then
  shots_dir="$(default_shots_dir)"
  latest="$(pick_latest "$shots_dir" 2>/dev/null || true)"
  if [ -z "$latest" ]; then
    printf 'pic-info: no screenshots found in %s\n' "$shots_dir" >&2
    exit 1
  fi
  set -- "$latest"
fi

for img in "$@"; do
  path="$(expand_path "$img")"
  if ! [ -e "$path" ]; then
    printf 'pic-info: skip missing %s\n' "$path" >&2
    continue
  fi
  "$notify_bin" "$path"
done
